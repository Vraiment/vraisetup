# Required variables:
# extension_id: The full extension id (as in mail: gsconnect@andyholmes.github.io)
# extension_version: The version of the extension (ex: 50)
# extension_hash: The hash of the extension archive
- name: Create cache directory
  file:
    path: "{{ ansible_env.HOME }}/.local/var/cache/vraisetup/gnome-extensions"
    state: directory
- name: Setup extension {{ extension_id }}
  block:
    # Download regardless to have the extension cached locally
    - name: Download {{ extension_id }} v{{ extension_version }}
      get_url:
        url: https://extensions.gnome.org/extension-data/{{ extension_id | replace('@', '') }}.v{{ extension_version }}.shell-extension.zip
        dest: "{{ ansible_env.HOME }}/.local/var/cache/vraisetup/gnome-extensions"
        checksum: "{{ extension_hash }}"
        force: no
    - name: Get current version of {{ extension_id }}
      shell: "gnome-extensions info {{ extension_id }} | grep Version | sed 's/^ \\+Version: \\+//'"
      register: current_extension_version
    - name: 'Version Information'
      debug:
        msg:
          - "Current version: {{ current_extension_version.stdout }}"
          - "New version: {{ extension_version }}"
    - when: current_extension_version.stdout | int < extension_version
      block:
      - name: Install {{ extension_id }} v{{ extension_version }}
        command: /usr/bin/gnome-extensions install --force "{{ ansible_env.HOME }}/.local/var/cache/vraisetup/gnome-extensions/{{ extension_id | replace('@', '') }}.v{{ extension_version }}.shell-extension.zip"
      - name: Enable {{ extension_id }} v{{ extension_version }}
        command: /usr/bin/gnome-extensions enable {{ extension_id }}
        # For whatever reason Ubuntu 24.04 won't detect new extensions until the next login
        # see https://bugs.launchpad.net/ubuntu/+source/gnome-software/+bug/2078424
        ignore_errors: true
